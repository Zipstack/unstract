name: Unstract Tools Docker Image Build and Push (Development)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Docker image tag"
        required: true
        default: "latest"
      service_name:
        description: "Tool to build"
        required: true
        default: "tool-structure" # Provide a default value
        type: choice
        options: # Define available options
          - tool-classifier
          - tool-structure
          - tool-text-extractor
          - tool-sidecar

run-name: "[${{ inputs.service_name }}:${{ inputs.tag }}] Docker Image Build and Push (Development)"

jobs:
    build-and-push:
      runs-on: ubuntu-latest
      steps:
        - name: Output Inputs
          run: echo "${{ toJSON(github.event.inputs) }}"

        - name: Checkout code
          uses: actions/checkout@v4

        # Set up Docker Buildx for better caching
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3

        # Log in to Docker Hub
        - name: Login to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}

        # Set up cache for tool-classifier
        - name: Build and push tool-classifier
          if: github.event.inputs.service_name=='tool-classifier'
          uses: docker/build-push-action@v5
          with:
            context: ./tools/classifier
            # push: true
            push: false  # TODO: Make true after testing is complete
            tags: unstract/${{github.event.inputs.service_name}}:${{ github.event.inputs.tag }}
            cache-from: type=gha
            cache-to: type=gha,mode=max

        # Set up cache for tool-structure
        - name: Build and push tool-structure
          if: github.event.inputs.service_name=='tool-structure'
          uses: docker/build-push-action@v5
          with:
            context: ./tools/structure
            # push: true
            push: false  # TODO: Make true after testing is complete
            tags: unstract/${{github.event.inputs.service_name}}:${{ github.event.inputs.tag }}
            cache-from: type=gha
            cache-to: type=gha,mode=max

        # Set up cache for tool-text-extractor
        - name: Build and push tool-text-extractor
          if: github.event.inputs.service_name=='tool-text-extractor'
          uses: docker/build-push-action@v5
          with:
            context: ./tools/text_extractor
            # push: true
            push: false  # TODO: Make true after testing is complete
            tags: unstract/${{github.event.inputs.service_name}}:${{ github.event.inputs.tag }}
            cache-from: type=gha
            cache-to: type=gha,mode=max

        # Set up cache for tool-sidecar
        - name: Build and push tool-sidecar
          if: github.event.inputs.service_name=='tool-sidecar'
          uses: docker/build-push-action@v5
          with:
            context: .
            file: docker/dockerfiles/tool-sidecar.Dockerfile
            # push: true
            push: false  # TODO: Make true after testing is complete
            tags: unstract/${{github.event.inputs.service_name}}:${{ github.event.inputs.tag }}
            cache-from: type=gha
            cache-to: type=gha,mode=max
